version: 2.1

jobs:
  code-quality:
    docker:
      - image: cimg/php:8.2-browsers
        environment:
          XDEBUG_MODE: coverage
    resource_class: small
    steps:
      - checkout
      - run:
          name: Instalar dependencias de Composer
          command: composer install
      - run:
          name: Crear carpeta para resultados de tests
          command: mkdir -p /home/circleci/project/test-results
      - run:
          name: Ejecutar PHPUnit con reporte JUnit y cobertura
          command: |
            export XDEBUG_MODE=coverage
            vendor/bin/phpunit --coverage-html coverage --log-junit test-results/phpunit.xml
      - run:
          name: Ejecutar PHPStan y exportar a XML JUnit
          command: vendor/bin/phpstan analyse src/ --error-format=junit > /home/circleci/project/test-results/phpstan.xml || true
      - run:
          name: Ejecutar PHPMD y exportar a XML
          command: vendor/bin/phpmd src/ xml cleancode,codesize,controversial,design,naming,unusedcode > /home/circleci/project/test-results/phpmd.xml || true
      - store_artifacts:
          path: /home/circleci/project/test-results/

workflows:
  test:
    jobs:
      - code-quality